<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Generate Payment</title>
<style>
body { font-family: Arial, sans-serif; background: #f6f8fb; margin:0; }
.layout { display: flex; min-height: 100vh; }
.sidebar { width: 230px; background: #fff; padding: 20px; }
.sidebar .logo { text-align:center; color: #2e7d32; margin-bottom:30px; }
.sidebar .menu { list-style:none; padding:0; }
.sidebar .menu li { margin-bottom:10px; }
.sidebar .menu a { text-decoration:none; color:#333; display:block; padding:10px; }
.sidebar .menu .active a { background:#2e7d32; color:#fff; border-radius:6px; }
.main { flex:1; padding:30px; }
.card { max-width:700px; background:#fff; padding:25px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.08); margin-top:20px; }
label { display:block; margin-top:15px; font-weight:bold; color:#555; }
input, select { width:80%; padding:8px; margin-top:4px; border-radius:4px; border:1px solid #ccc; }
input[readonly] { background:#f1f1f1; }
.btn { margin-top:22px; padding:10px; width:80%; background:green; color:white; border:none; border-radius:6px; font-size:15px; cursor:pointer; }
.btn:hover { background:darkgreen; }
.toast { padding:12px; margin-top:10px; border-radius:6px; color:white; display:none; }
.toast.success { background: #2e7d32; }
.toast.error { background: #e53935; }
.small-note { font-weight: normal; font-size: 13px; margin-left:5px; color:#555; }
.row { display:flex; gap:10px; flex-wrap:wrap; }
.row > div { flex:1; min-width:150px; }

/* Farmer dropdown styling */
.farmer-container { position: relative; width: 80%; }
#farmersDropdown { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border:1px solid #ccc; max-height:200px; overflow-y:auto; display:none; z-index:1000; }
#farmersDropdown .custom-option { padding:8px; cursor:pointer; }
#farmersDropdown .custom-option:hover { background:#f0f0f0; }
</style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <h2 class="logo">ADMIN PANEL</h2>
        <ul class="menu">
            <li><a href="admin_dashboard.html">Dashboard</a></li>
            <li><a href="milk_collections.html">Collections</a></li>
            <li class="active"><a href="payments.html">Payments</a></li>
            <li><a href="collection_centers.html">Collection Centers</a></li>
        </ul>
    </aside>

    <main class="main">
        <h1>Generate Farmer Payment</h1>

        <div class="card">
            <form id="paymentForm">

                <!-- Farmer input with searchable dropdown -->
                <label>Farmer</label>
                <div class="farmer-container">
                    <input id="farmerInput" placeholder="Search farmer..." autocomplete="off">
                    <div id="farmersDropdown"></div>
                </div>
                <input type="hidden" id="farmerId" name="farmerId">

                <!-- Unpaid milk toggle -->
                <label>
                    Unpaid Milk (Liters)
                    <input type="checkbox" id="autoMilk" checked>
                   
                </label>
                <input type="number" id="unpaidLiters" readonly>

                <!-- Unit Price -->
                <label>Unit Price (RWF)</label>
                <input type="number" id="unitPrice" readonly>

                <!-- Total Amount -->
                <div class="row">
                    <div>
                        <label>Total Amount (RWF)</label>
                        <input type="number" id="amount" placeholder="Auto calculated" required>
                    </div>
                </div>

                <!-- Payment Method -->
                <label>Payment Method</label>
                <select id="paymentMethod" required>
                    <option value="">Select payment method</option>
                    <option value="cash">Cash</option>
                    <option value="Mobile money">Mobile Money</option>
                    <option value="Bank transfer">Bank Transfer</option>
                </select>

                <button type="submit" class="btn">Generate Payment</button>
                <div id="toast" class="toast"></div>

            </form>
        </div>
    </main>
</div>

<script>
const farmerInput = document.getElementById('farmerInput');
const farmersDropdown = document.getElementById('farmersDropdown');
const farmerIdInput = document.getElementById('farmerId');
const unpaidLitersInput = document.getElementById('unpaidLiters');
const unitPriceInput = document.getElementById('unitPrice');
const amountInput = document.getElementById('amount');
const paymentForm = document.getElementById('paymentForm');
const toast = document.getElementById('toast');
const autoMilkCheckbox = document.getElementById('autoMilk');

let farmers = [];
let selectedUnitPrice = 0;

// Load farmers from API
async function loadFarmers() {
    try {
        const res = await fetch('https://milk-api-l8fd.onrender.com/api/user-names');
        const data = await res.json();
        farmers = data.users || [];
    } catch(e) {
        console.error(e); 
        farmers = [];
    }
}
loadFarmers();

// Render dropdown
function renderFarmerDropdown(filter='') {
    farmersDropdown.innerHTML = '';
    const q = filter.toLowerCase();
    const matches = farmers.filter(f => f.fullname.toLowerCase().includes(q));
    if(matches.length){
        matches.forEach(f => {
            const div = document.createElement('div');
            div.className = 'custom-option';
            div.textContent = f.fullname;
            div.addEventListener('click', () => selectFarmer(f));
            farmersDropdown.appendChild(div);
        });
    } else {
        const div = document.createElement('div');
        div.className = 'custom-option';
        div.textContent = 'No results';
        farmersDropdown.appendChild(div);
    }
    farmersDropdown.style.display = 'block';
}

// Select farmer and show unpaid liters & unit price
function selectFarmer(f) {
    farmerInput.value = f.fullname;
    farmerIdInput.value = f.id;

    const quantity = f.total_quantity || 0;
    selectedUnitPrice = f.unit_price || 0;

    unpaidLitersInput.value = quantity;
    unitPriceInput.value = selectedUnitPrice;
    amountInput.value = quantity * selectedUnitPrice;

    if(autoMilkCheckbox.checked){
        unpaidLitersInput.setAttribute('readonly', true);
    }

    farmersDropdown.style.display = 'none';
}

// Auto/manual toggle
autoMilkCheckbox.addEventListener('change', () => {
    if (autoMilkCheckbox.checked) {
        unpaidLitersInput.setAttribute('readonly', true);
        const liters = parseFloat(unpaidLitersInput.value) || 0;
        amountInput.value = liters * selectedUnitPrice;
    } else {
        unpaidLitersInput.removeAttribute('readonly');
        unpaidLitersInput.value = '';
        amountInput.value = '';
    }
});

// Recalculate amount if manually changing liters
unpaidLitersInput.addEventListener('input', () => {
    const liters = parseFloat(unpaidLitersInput.value) || 0;
    amountInput.value = liters * selectedUnitPrice;
});

// Event listeners for dropdown
farmerInput.addEventListener('focus', () => renderFarmerDropdown(farmerInput.value));
farmerInput.addEventListener('input', () => renderFarmerDropdown(farmerInput.value));
document.addEventListener('click', e => {
    if(!farmerInput.contains(e.target) && !farmersDropdown.contains(e.target)) {
        farmersDropdown.style.display = 'none';
    }
});

// Submit payment
paymentForm.addEventListener('submit', async e => {
    e.preventDefault();
    const farmerId = farmerIdInput.value;
    const quantity = parseFloat(unpaidLitersInput.value);
    const amount = parseFloat(amountInput.value);
    const payment_method = document.getElementById('paymentMethod').value;

    if(!farmerId){ showToast('Select a valid farmer', 'error'); return; }

    try {
        const res = await fetch('https://milk-api-l8fd.onrender.com/api/payment', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ farmer_id: farmerId, quantity, amount, payment_method })
        });
        const data = await res.json();
        if(data.status === 'success'){
            showToast('Payment created successfully!', 'success');
            paymentForm.reset();
            unpaidLitersInput.value = '';
            unitPriceInput.value = '';
            amountInput.value = '';
        } else {
            showToast(data.message || 'Error creating payment', 'error');
        }
    } catch(err){
        console.error(err);
        showToast('Server error', 'error');
    }
});

function showToast(msg, type){
    toast.textContent = msg;
    toast.className = 'toast ' + type;
    toast.style.display = 'block';
    setTimeout(()=> { toast.style.display = 'none'; }, 3000);
}
</script>

</body>
</html>
