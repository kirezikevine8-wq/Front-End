<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Collection Centers</title>
  <link rel="stylesheet" href="collection_centers.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2 class="logo">ADMIN PANEL</h2>
    <ul class="menu">
      <li><a href="admin_dashboard.html">Dashboard</a></li>
      <li><a href="milk_collections.html">Collections</a></li>
      <li><a href="payments.html">Payments</a></li>
      <li class="active"><a href="collection_centers.html">Collection Centers</a></li>
      <li><a href="reports.html">Reports</a></li>
    </ul>
  </aside>

  <!-- Main content -->
  <main class="main">
    <div class="page-header">
      <div>
        <h1>Collection Centers</h1>
        <p>Manage your collection center locations</p>
      </div>
    </div>

    <div id="status" class="loading">Loading collection centers...</div>

    <div class="table-card" id="tableCard" style="display:none;">
      <div class="table-controls">
        <input id="searchInput" placeholder="Search by name or code">
        <select id="pageSizeSelect" title="Rows per page">
         
          <option value="5" selected>5 / page</option>
          <option value="10">10 / page</option>
          <option value="20">20 / page</option>
          <option value="50">50 / page</option>
        </select>
        <button id="addCenterBtn" class="btn primary">+ Add Center</button>
      </div>
      <table id="centersTable">
        <thead>
              <tr>
                <th>Name</th>
                <th>Code</th>
                <th>Manager</th>
                <th>Phone</th>
                <th>Price (RWF)</th>
                <th>Location</th>
                <th>Actions</th>
              </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="table-footer">
        <div id="pagination" class="pagination"></div>
      </div>
    </div>
  </main>
</div>

<!-- Modal for adding center -->
<div id="addModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Add Collection Center</h3>
    <form id="addCenterForm">
      <input type="text" id="name" placeholder="Name" required>
      <input type="text" id="code" placeholder="Code" required>
      <input type="text" id="manager" placeholder="Manager" required>
      <input type="text" id="phone" placeholder="Phone" required>
      <input type="number" id="price" placeholder="Price" required>
      <input type="text" id="location" placeholder="Location" required>
      <div style="margin-top:10px; text-align:right;">
        <button type="button" id="saveCenterBtn" class="btn primary">Save Center</button>
      </div>
    </form>
  </div>
</div>

<script>
  const apiUrl = 'https://milk-api-l8fd.onrender.com/api/collection-centers';

  const addBtn = document.getElementById('addCenterBtn');
  const modal = document.getElementById('addModal');
  const closeBtn = modal.querySelector('.close');
  const form = document.getElementById('addCenterForm');
  const saveBtn = document.getElementById('saveCenterBtn');
  const tableCard = document.getElementById('tableCard');
  const table = document.getElementById('centersTable');
  const tbody = table.querySelector('tbody');
  const statusDiv = document.getElementById('status');
  const searchInput = document.getElementById('searchInput');
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  const paginationDiv = document.getElementById('pagination');

  let centersData = [];
  let currentPage = 1;
  let pageSize = Number(pageSizeSelect.value) || 8;

  // Open modal
  addBtn.addEventListener('click', () => { modal.style.display = 'block'; });

  // Close modal
  closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
  window.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

  // Helpers
  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str).replace(/[&<>"']/g, function (s) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[s]; });
  }

  function showToast(message, type = 'success', timeout = 3500) {
    let container = document.getElementById('toastContainer');
    if (!container) {
      container = document.createElement('div');
      container.id = 'toastContainer';
      document.body.appendChild(container);
    }
    const toast = document.createElement('div');
    toast.className = 'toast ' + (type === 'error' ? 'error' : 'success');
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.add('hide'); setTimeout(() => toast.remove(), 400); }, timeout);
    toast.addEventListener('click', () => toast.remove());
  }

  // Fetch data and initialize
  function init() {
    fetch(apiUrl, { method: 'GET', headers: { 'Accept': '*/*' } })
      .then(response => { if (!response.ok) throw new Error('Network response was not ok'); return response.json(); })
      .then(data => {
        centersData = data.centers || [];
        if (centersData.length === 0) {
          statusDiv.textContent = 'No collection centers found.';
          statusDiv.style.display = 'block';
          tableCard.style.display = 'none';
          return;
        }
        renderTable(1);
        statusDiv.style.display = 'none';
        tableCard.style.display = 'block';
      })
      .catch(error => { statusDiv.textContent = 'Error loading collection centers: ' + error.message; statusDiv.className = 'error'; });
  }

  // removed manager filter; page-size selector handles rows per page

  function getFiltered() {
    const q = (searchInput.value || '').toLowerCase();
    return centersData.filter(c => {
      const name = (c.name||'').toLowerCase();
      const code = (c.code||'').toLowerCase();
      const matchesQuery = !q || name.includes(q) || code.includes(q);
      return matchesQuery;
    });
  }

  function renderTable(page = 1) {
    const filtered = getFiltered();
    const total = filtered.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    currentPage = Math.min(Math.max(1, page), totalPages);
    tbody.innerHTML = '';
    const start = (currentPage - 1) * pageSize;
    const slice = filtered.slice(start, start + pageSize);
    slice.forEach(center => {
      const row = document.createElement('tr');
      row.dataset.id = center.id || center._id || '';
      row.innerHTML = `
        <td>${escapeHtml(center.name)}</td>
        <td>${escapeHtml(center.code)}</td>
        <td>${escapeHtml(center.manager)}</td>
        <td>${escapeHtml(center.phone)}</td>
        <td>${escapeHtml(center.price)}</td>
        <td>${escapeHtml(center.location)}</td>
        <td>
          <div class="dropdown">
            <button class="moreBtn">â‹®</button>
            <div class="dropdown-menu" style="display:none;">
              <button class="dropdown-item deleteBtn">Delete</button>
            </div>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
    renderPagination(totalPages);
    // status/table visibility
    if (total === 0) {
      statusDiv.textContent = 'No collection centers found.';
      statusDiv.style.display = 'block';
      tableCard.style.display = 'none';
    } else {
      statusDiv.style.display = 'none';
      tableCard.style.display = 'block';
    }
  }

  function renderPagination(totalPages) {
    paginationDiv.innerHTML = '';
    const prev = document.createElement('button'); prev.textContent = 'Prev'; prev.disabled = currentPage === 1;
    prev.addEventListener('click', () => renderTable(currentPage - 1));
    paginationDiv.appendChild(prev);

    // show up to 5 page buttons centered
    const maxButtons = 5;
    let start = Math.max(1, currentPage - Math.floor(maxButtons/2));
    let end = Math.min(totalPages, start + maxButtons -1);
    if (end - start < maxButtons -1) start = Math.max(1, end - maxButtons +1);
    for (let p = start; p <= end; p++) {
      const btn = document.createElement('button'); btn.textContent = p; if (p === currentPage) btn.classList.add('active');
      btn.addEventListener('click', () => renderTable(p));
      paginationDiv.appendChild(btn);
    }

    const next = document.createElement('button'); next.textContent = 'Next'; next.disabled = currentPage === totalPages;
    next.addEventListener('click', () => renderTable(currentPage + 1));
    paginationDiv.appendChild(next);
  }

  // Save new center
  saveBtn.addEventListener('click', () => {
    const payload = {
      name: document.getElementById('name').value.trim(),
      code: document.getElementById('code').value.trim(),
      manager: document.getElementById('manager').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      price: Number(document.getElementById('price').value),
      location: document.getElementById('location').value.trim()
    };

    if (!payload.name || !payload.code || !payload.manager || !payload.phone || !payload.price || !payload.location) {
      showToast('Please fill all fields', 'error');
      return;
    }

    fetch('https://milk-api-l8fd.onrender.com/api/collection-center', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) })
      .then(res => { if (!res.ok) throw new Error('Failed to save center'); return res.json(); })
      .then(data => {
        if (data.status === 'success') {
          centersData.unshift(data.center);
          renderTable(1);
          form.reset();
          modal.style.display = 'none';
          showToast('Collection center added successfully', 'success');
        } else {
          showToast('Failed to add center', 'error');
        }
      })
      .catch(err => { showToast('Error: ' + err.message, 'error'); });
  });

  // Search and page-size events
  searchInput.addEventListener('input', () => renderTable(1));
  pageSizeSelect.addEventListener('change', () => { pageSize = Number(pageSizeSelect.value) || 8; renderTable(1); });

  // Toggle dropdown menus and handle Delete via delegation
  document.addEventListener('click', (e) => {
    const more = e.target.closest('.moreBtn');
    // close all menus unless clicking a moreBtn
    document.querySelectorAll('.dropdown-menu').forEach(m => { if (!m.contains(e.target)) m.style.display = 'none'; });
    if (more) {
      const menu = more.parentElement.querySelector('.dropdown-menu');
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
      return;
    }

    const del = e.target.closest('.deleteBtn');
    if (!del) return;
    const row = del.closest('tr');
    const id = row && row.dataset && row.dataset.id;
    if (!id) { showToast('Cannot determine center id', 'error'); return; }

    Swal.fire({
      title: 'Delete collection center?',
      text: 'This action cannot be undone.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete'
    }).then((result) => {
      if (!result.isConfirmed) return;
      // visually mark then remove from data
      const domRow = document.querySelector(`tr[data-id="${id}"]`);
      if (domRow) domRow.classList.add('deleted');
      const delUrl = 'https://milk-api-l8fd.onrender.com/api/collection-center/' + encodeURIComponent(id);
      fetch(delUrl, { method: 'DELETE', headers: { 'Accept': '*/*' } })
        .then(res => { if (!res.ok) throw new Error('Delete request failed'); return res.json(); })
        .then(data => {
          if (data.status === 'success') {
            // remove from centersData and re-render after brief highlight
            setTimeout(() => {
                  centersData = centersData.filter(c => (c.id||c._id||'') !== id);
                  // keep on same page if possible
                  renderTable(currentPage);
              showToast(data.message || 'Collection center deleted', 'success');
            }, 450);
          } else {
            Swal.fire('Delete failed', data.message || 'Unknown error', 'error');
            if (domRow) domRow.classList.remove('deleted');
          }
        })
        .catch(err => { Swal.fire('Error', err.message, 'error'); if (domRow) domRow.classList.remove('deleted'); });
    });
  });

  // initialize
  init();
  
</script>

</body>
</html>
