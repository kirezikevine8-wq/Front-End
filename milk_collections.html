<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Milk Collection</title>
    <link rel="stylesheet" href="milk_collections.css">
</head>
<body>

<div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
        <h2 class="logo">ADMIN PANEL</h2>
        <ul class="menu">
             <li><a href="admin_dashboard.html">Dashboard</li>
            <li class="active">Collections</li>
            <li><a href="payments.html">Payments</a></li>
            <li><a href="collection_centers.html">Collection Centers</a></li>
            <li><a href="reports.html">Reports</a></li>
            
        </ul>
    </aside>

    <!-- Main -->
    <main class="main">

        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1>Milk Collection</h1>
                <p>Record and manage all milk collections</p>
            </div>
           
        </div>

        <div class="content">

            <!-- Record New Delivery -->
            <div class="card">
                <h3>Record New Delivery</h3>

                <form id="recordForm">
                                <div class="form-group">
                                                    <label>Select Collection Center</label>
                                                    <input id="centerInput" placeholder="Search collection center..." autocomplete="off">
                                                    <div class="custom-dropdown" id="centersDropdown" aria-hidden="true"></div>
                                                    <input type="hidden" id="centerId" name="centerId">
                                                </div>
                    <div class="form-group">
                        <label>Select Farmer</label>
                        <input id="farmerInput" placeholder="Search farmer..." autocomplete="off">
                        <div class="custom-dropdown" id="farmersDropdown" aria-hidden="true"></div>
                        <input type="hidden" id="farmerId" name="farmerId">
                    </div>

                    <div class="form-group">
                        <label>Quantity (Liters)</label>
                        <input id="quantityInput" type="number" placeholder="Enter quantity">
                    </div>

                    <div class="form-group">
                        <label>Milk Quality</label>
                        <select id="qualitySelect">
                            <option value="">Select quality</option>
                            <option value="EXCELLENT">Excellent</option>
                            <option value="GOOD">Good</option>
                            <option value="POOR">Poor</option>
                        </select>
                    </div>

                    <button id="recordBtn" class="btn primary" type="submit">
                        <span class="btn-spinner" aria-hidden="true"></span>
                        <span class="btn-text">Record Delivery</span>
                    </button>
                </form>
                <div id="toastContainer"></div>
            </div>

            <!-- Recent Collections -->
            <div class="card">
                <h3>Recent Collections</h3>
                <div id="recentCollectionsList">
                    <!-- recent items will be injected here -->
                </div>
            </div>

        </div>
        
        </div>

        <script>
        // Create custom dropdowns rendered in-frame (not native popups)
        (function(){
            const centersApi = 'https://milk-api-l8fd.onrender.com/api/collection-centers';
            const usersApi = 'https://milk-api-l8fd.onrender.com/api/user-names';

            const centerInput = document.getElementById('centerInput');
            const centersDropdown = document.getElementById('centersDropdown');
            const centerHidden = document.getElementById('centerId');

            const farmerInput = document.getElementById('farmerInput');
            const farmersDropdown = document.getElementById('farmersDropdown');
            const farmerHidden = document.getElementById('farmerId');

            let centers = [];
            let farmers = [];

            function createDropdownBehavior(inputEl, dropdownEl, items, toDisplay, toId, hiddenEl){
                let visible = false;
                // attach items and helpers so other code (form submit) can map typed text -> id
                try { inputEl.__items = items; inputEl.__toDisplay = toDisplay; inputEl.__toId = toId; } catch(e){}
                function renderList(filter){
                    dropdownEl.innerHTML = '';
                    const frag = document.createDocumentFragment();
                    const q = String(filter||'').toLowerCase();
                    items.filter(it => toDisplay(it).toLowerCase().includes(q)).slice(0, 100).forEach(it => {
                        const div = document.createElement('div');
                        div.className = 'custom-option';
                        div.textContent = toDisplay(it);
                        div.tabIndex = 0;
                        div.dataset.id = toId(it);
                        // mark selected if hidden matches
                        try { if (hiddenEl && hiddenEl.value && String(hiddenEl.value) === String(toId(it))) div.classList.add('selected'); } catch(e){}
                        div.addEventListener('click', () => selectItem(it));
                        div.addEventListener('keydown', (e) => { if (e.key === 'Enter') selectItem(it); });
                        frag.appendChild(div);
                    });
                    if (!frag.childNodes.length){
                        const empty = document.createElement('div');
                        empty.className = 'custom-empty';
                        empty.textContent = 'No results';
                        frag.appendChild(empty);
                    }
                    dropdownEl.appendChild(frag);
                }
                function open(){ dropdownEl.style.display = 'block'; dropdownEl.setAttribute('aria-hidden','false'); visible = true; }
                function close(){ dropdownEl.style.display = 'none'; dropdownEl.setAttribute('aria-hidden','true'); visible = false; }
                function selectItem(it){
                    inputEl.value = toDisplay(it);
                    if (hiddenEl) hiddenEl.value = toId(it) || '';
                    close();
                    inputEl.focus();
                }
                inputEl.addEventListener('input', (e) => { renderList(e.target.value); open(); });
                inputEl.addEventListener('focus', () => { renderList(inputEl.value); open(); });
                document.addEventListener('click', (ev) => { if (!inputEl.contains(ev.target) && !dropdownEl.contains(ev.target)) close(); });
                inputEl.addEventListener('keydown', (e) => {
                    if (!visible && e.key === 'ArrowDown'){ renderList(inputEl.value); open(); return; }
                    if (visible){
                        const opt = dropdownEl.querySelector('.custom-option');
                        if (e.key === 'Escape') close();
                    }
                });
                if (hiddenEl) hiddenEl.value = '';
            }

            // Fetch centers
            fetch(centersApi, { method: 'GET', headers: { 'Accept': '*/*' } })
                .then(r => { if (!r.ok) throw new Error('Failed to fetch centers'); return r.json(); })
                .then(data => { centers = data.centers || []; createDropdownBehavior(centerInput, centersDropdown, centers, c => `${c.name} — ${c.code}`, c => c.id || c._id || ''); })
                .catch(() => { centers = []; createDropdownBehavior(centerInput, centersDropdown, centers, c => `${c.name} — ${c.code}`, c => c.id || c._id || ''); });

            // Fetch farmers/users
            fetch(usersApi, { method: 'GET', headers: { 'Accept': 'application/json' } })
                .then(r => { if (!r.ok) throw new Error('Failed to fetch users'); return r.json(); })
                .then(data => { farmers = data.users || []; createDropdownBehavior(farmerInput, farmersDropdown, farmers, u => `${u.fullname}`, u => u.id || u._id || ''); })
                .catch(() => { farmers = []; createDropdownBehavior(farmerInput, farmersDropdown, farmers, u => `${u.fullname}`, u => u.id || u._id || ''); });

        })();

        // Form submit: create new collection
        (function(){
            const form = document.getElementById('recordForm');
            const toastContainer = document.getElementById('toastContainer');
            function showToast(msg, type){
                if (!toastContainer) return;
                const t = document.createElement('div');
                t.className = 'toast' + (type === 'error' ? ' error' : '');
                t.textContent = msg;
                toastContainer.appendChild(t);
                setTimeout(()=> t.classList.add('hide'), 2400);
                setTimeout(()=> t.remove(), 3000);
            }

            if (!form) return;
            form.addEventListener('submit', function(e){
                e.preventDefault();
                let centerId = document.getElementById('centerId').value;
                let userId = document.getElementById('farmerId').value;
                const quantity = Number(document.getElementById('quantityInput').value || 0);
                const quality = document.getElementById('qualitySelect').value;

                // If hidden IDs are empty (user typed but didn't click), try to map typed text to ids
                if (!centerId){
                    const centerInputEl = document.getElementById('centerInput');
                    try {
                        const items = centerInputEl.__items || [];
                        const toDisplay = centerInputEl.__toDisplay || (i=>i.name);
                        const toId = centerInputEl.__toId || (i=>i.id);
                        const found = items.find(it => String(toDisplay(it)).toLowerCase() === String(centerInputEl.value).toLowerCase());
                        if (found) centerId = toId(found) || '';
                    } catch(e){}
                }
                if (!userId){
                    const farmerInputEl = document.getElementById('farmerInput');
                    try {
                        const items = farmerInputEl.__items || [];
                        const toDisplay = farmerInputEl.__toDisplay || (i=>i.fullname);
                        const toId = farmerInputEl.__toId || (i=>i.id);
                        const found = items.find(it => String(toDisplay(it)).toLowerCase() === String(farmerInputEl.value).toLowerCase());
                        if (found) userId = toId(found) || '';
                    } catch(e){}
                }

                if (!centerId){ showToast('Please select a collection center', 'error'); return; }
                if (!userId){ showToast('Please select a farmer', 'error'); return; }
                if (!quantity || quantity <= 0){ showToast('Enter a valid quantity', 'error'); return; }
                if (!quality){ showToast('Select milk quality', 'error'); return; }

                const payload = {
                    collection_center_id: centerId,
                    user_id: userId,
                    quantity: quantity,
                    quality: quality
                };
                const submitBtn = document.getElementById('recordBtn');
                try { submitBtn.classList.add('loading'); submitBtn.disabled = true; } catch(e){}

                fetch('https://milk-api-l8fd.onrender.com/api/created-collection', {
                    method: 'POST',
                    headers: {
                        'Accept': '*/*',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                }).then(r => {
                    if (r.status === 201) return r.json();
                    return r.json().then(j => Promise.reject(j));
                }).then(json => {
                    showToast('Collection recorded successfully');
                    form.reset();
                    document.getElementById('centerId').value = '';
                    document.getElementById('farmerId').value = '';
                    // refresh recent collections
                    try { if (typeof refreshRecent === 'function') refreshRecent(); } catch(e){}
                }).catch(err => {
                    const msg = err && err.message ? err.message : 'Failed to record collection';
                    showToast(msg, 'error');
                }).finally(() => {
                    try { submitBtn.classList.remove('loading'); submitBtn.disabled = false; } catch(e){}
                });

            });
        })();

        // Fetch and render recent collections
        function refreshRecent(){
            const container = document.getElementById('recentCollectionsList');
            if (!container) return;
            container.innerHTML = '<p style="color:#777;padding:12px">Loading...</p>';
            fetch('https://milk-api-l8fd.onrender.com/api/created-collections/recent', { method: 'GET', headers: { 'Accept': '*/*' } })
                .then(r => { if (!r.ok) throw new Error('Failed to fetch recent collections'); return r.json(); })
                .then(data => {
                    const items = data.collections || [];
                    container.innerHTML = '';
                    if (!items.length){ container.innerHTML = '<p style="color:#777;padding:12px">No recent collections</p>'; return; }
                    items.forEach(it => {
                        const wrap = document.createElement('div');
                        wrap.className = 'collection-item';
                        const left = document.createElement('div');
                        const strong = document.createElement('strong');
                        strong.textContent = it.quantity || '';
                        const p = document.createElement('p');
                        p.textContent = it.user || '';
                        const span = document.createElement('span');
                        span.textContent = it.date_center || '';
                        left.appendChild(strong);
                        left.appendChild(p);
                        left.appendChild(span);
                        const badge = document.createElement('span');
                        badge.className = 'badge ' + (it.quality === 'EXCELLENT' ? 'excellent' : (it.quality === 'GOOD' ? 'good' : 'poor'));
                        badge.textContent = (it.quality || '').toUpperCase();
                        wrap.appendChild(left);
                        wrap.appendChild(badge);
                        container.appendChild(wrap);
                    });
                }).catch(() => { container.innerHTML = '<p style="color:#777;padding:12px">Failed to load recent collections</p>'; });
        }

        // initial load
        try { refreshRecent(); } catch(e){}
        </script>
    </main>
</div>

</body>
</html>
